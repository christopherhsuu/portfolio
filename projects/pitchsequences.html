    <!-- Only keep the unified project container version below -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pitch Sequences — Christopher Hsu</title>
    <link href="../styles.css" rel="stylesheet">
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <a href="/" class="site-title">Christopher Hsu</a>
          <p class="tagline">Data Science &amp; Sabermetrics</p>
        </div>
        <nav aria-label="Main navigation">
          <ul class="nav-list">
            <li><a href="/">Home</a></li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </nav>
      </div>
    </header>

  <main class="section page-inner" style="max-width:1400px; margin:32px auto 0 auto; background:#16161a; border-radius:18px; box-shadow:0 4px 32px 0 rgba(0,0,0,0.12);">
    <div class="project-container">
      <div style="margin-top:20px; display:flex; gap:12px; align-items:center;">
        <a class="launch-big" href="https://pitchsequence.streamlit.app/" target="_blank" rel="noopener noreferrer">Launch (Live)</a>
        <a class="btn ghost" href="https://github.com/christopherhsuu/pitchsequence/tree/main" target="_blank" rel="noopener noreferrer">Code</a>
      </div>
      <h1>Pitch Sequences</h1>
      <p class="muted">An interactive visualization of pitch sequences, pitch types, and swing outcomes. The app helps explore sequencing patterns and batter responses by zone and count.</p>
      <section class="prose max-w-4xl text-gray-200 mt-8 space-y-6">
        <h2 class="font-bold text-2xl mt-8 mb-2">Methodology &amp; Execution</h2>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">Overview</h3>
        <p style="line-height:1.25em;">
          <strong>PitchSequence</strong> is a sabermetric machine-learning pipeline and interactive <strong>Streamlit</strong> app that recommends the next pitch a pitcher should throw in a given situation. It blends <strong>Statcast</strong> data, batter archetypes, pitcher arsenals, and a run-value prediction model to simulate how decisions impact expected runs.
        </p>
        <p style="line-height:1.25em;">
          The system integrates data processing, feature engineering, model training, and UI design to create an explainable recommender that mirrors real-world pitch-calling logic.
        </p>

        <h3 class="font-bold text-xl mt-6 mb-2">1. Data Preparation</h3>
        <h4 class="font-semibold text-lg mt-4 mb-2">Directories &amp; inputs</h4>
        <table class="min-w-full text-sm border border-gray-700 mb-4">
          <thead>
            <tr class="bg-gray-800">
              <th class="px-4 py-2 text-left font-semibold">Folder</th>
              <th class="px-4 py-2 text-left font-semibold">Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>data/raw/</code></td>
              <td class="px-4 py-2">Raw Statcast dumps (statcast_2025.csv, name mapping files)</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>data/processed/</code></td>
              <td class="px-4 py-2">Cleaned and feature-engineered Parquet files (cleaned.parquet, features.parquet, runvalue.parquet)</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>pitcher_assets/pitcher_arsenals.csv</code></td>
              <td class="px-4 py-2">Inferred pitcher arsenals derived from Statcast</td>
            </tr>
          </tbody>
        </table>
        <ul class="list-disc ml-6 space-y-2">
          <li>Data ingestion begins by placing raw CSVs in <code>data/raw/</code> and running <code>src/preprocess.py</code>, which:
            <ul class="list-disc ml-6 space-y-1">
              <li>Parses timestamps and cleans inconsistent or missing rows.</li>
              <li>Normalizes pitch type labels (FF, SL, CH, etc.).</li>
              <li>Ensures batter and pitcher names align across datasets.</li>
              <li>Drops invalid rows lacking pitch type or outcome information.</li>
            </ul>
          </li>
          <li>Next, <code>src/feature_engineering.py</code> computes play-level and aggregate features:
            <ul class="list-disc ml-6 space-y-1">
              <li>Maps categorical pitch locations (“Top-In”, “Low-Away”) to numeric plate coordinates (<code>plate_x</code>, <code>plate_z</code>).</li>
              <li>Calculates <code>last_pitch_speed_delta</code> and contextual deltas.</li>
              <li>Aggregates batter vs. pitch_type statistics such as:
                <ul class="list-disc ml-6 space-y-1">
                  <li><code>batter_pitchtype_woba</code></li>
                  <li><code>batter_pitchtype_whiff_rate</code></li>
                  <li><code>batter_pitchtype_run_value</code></li>
                </ul>
              </li>
            </ul>
          </li>
          <li>Data cleaning &amp; filtering:
            <ul class="list-disc ml-6 space-y-1">
              <li>Missing numeric values are imputed with contextual defaults (e.g., 0 for missing rates).</li>
              <li>Unrealistic outliers (e.g., release speeds &gt;105 mph) are winsorized.</li>
              <li>Pitchers/batters with insufficient sample sizes are filtered out to stabilize estimates.</li>
              <li>Only recent seasons (1–3 years) are used for modeling to avoid historical drift.</li>
              <li>All processed outputs are saved to <code>data/processed/</code> for efficient re-use during model training.</li>
            </ul>
          </li>
        </ul>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">2. Feature Engineering</h3>
        <ul class="list-disc ml-6 space-y-2">
          <li><strong>Core features:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Count &amp; base state: <code>balls</code>, <code>strikes</code>, <code>outs_when_up</code>, <code>on_1b</code>, <code>on_2b</code>, <code>on_3b</code></li>
              <li>Pitch data: <code>pitch_type</code>, <code>release_speed</code>, <code>release_spin_rate</code></li>
              <li>Plate location: <code>plate_x</code>, <code>plate_z</code>, <code>zone</code></li>
              <li>Temporal context: <code>last_pitch_type</code>, <code>last_pitch_result</code>, <code>last_pitch_speed_delta</code></li>
              <li>Batter matchup metrics: <code>batter_pitchtype_woba</code>, <code>batter_pitchtype_whiff_rate</code>, <code>batter_pitchtype_run_value</code></li>
            </ul>
          </li>
          <li><strong>Transformations:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Categorical features are one-hot or target-encoded in the model pipeline.</li>
              <li>Numeric variables are scaled as needed.</li>
              <li>Interaction terms such as <code>count × pitch_type</code> capture strategic context.</li>
            </ul>
          </li>
          <li><strong>Rationale:</strong>
            <p style="line-height:1.25em;">The feature space merges physical characteristics (pitch speed, location) with situational and matchup information, enabling the model to predict not just what is thrown, but what should be thrown to minimize run expectancy.</p>
          </li>
        </ul>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">3. Model Training</h3>
        <ul class="list-disc ml-6 space-y-2">
          <li>The training logic resides in <code>src/model_train.py</code>, producing a serialized artifact at <code>artifacts/runvalue_model.pkl</code>.</li>
          <li><strong>Pipeline steps:</strong>
            <ol class="list-decimal ml-6 space-y-1">
              <li>Load preprocessed data from <code>data/processed/features.parquet</code> and run-value targets from <code>runvalue.parquet</code>.</li>
              <li>Split data into train/validation/test sets using a time-based split to prevent data leakage.</li>
              <li>Construct a scikit-learn pipeline for:
                <ul class="list-disc ml-6 space-y-1">
                  <li>Categorical encoding</li>
                  <li>Missing-value imputation</li>
                  <li>Scaling</li>
                  <li>Regression model training</li>
                </ul>
              </li>
              <li>Train candidate regressors such as:
                <ul class="list-disc ml-6 space-y-1">
                  <li><code>RandomForestRegressor</code></li>
                  <li><code>GradientBoostingRegressor</code></li>
                </ul>
              </li>
              <li>Optimize hyperparameters via grid or randomized search.</li>
              <li>Evaluate with <code>MSE</code>, <code>MAE</code>, and explained variance, selecting the model with the lowest error on validation data.</li>
              <li>Save the fitted model using <code>joblib.dump()</code> or <code>pickle</code> for deployment.</li>
            </ol>
          </li>
          <li><strong>Notes:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Version alignment for scikit-learn is crucial to avoid unpickling errors.</li>
              <li>For long-term maintenance, pin dependencies in <code>requirements.txt</code>.</li>
            </ul>
          </li>
        </ul>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">4. Evaluation</h3>
        <ul class="list-disc ml-6 space-y-2">
          <li>Evaluation focuses on both numerical accuracy and strategic validity:</li>
          <li><strong>Metrics:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Mean Squared Error (<code>MSE</code>)</li>
              <li>Mean Absolute Error (<code>MAE</code>)</li>
              <li>Explained Variance</li>
            </ul>
          </li>
          <li><strong>Decision-support quality:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Tests whether the model’s ranked pitch recommendations correlate with lower realized run values.</li>
            </ul>
          </li>
          <li><strong>Diagnostics:</strong>
            <ul class="list-disc ml-6 space-y-1">
              <li>Residual plots</li>
              <li>Feature importance charts</li>
              <li>Partial dependence plots</li>
            </ul>
          </li>
          <li>A time-aware cross-validation (sliding-window approach) ensures robustness against season-to-season variation.</li>
        </ul>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">5. Deployment &amp; UI</h3>
        <ul class="list-disc ml-6 space-y-2">
          <li>Deployment centers on <code>app.py</code>, a Streamlit interface that orchestrates the at-bat simulation.</li>
        </ul>
        <h4 class="font-semibold text-lg mt-4 mb-2">Runtime flow</h4>
        <ol class="list-decimal ml-6 space-y-1">
          <li>Load the trained model (<code>artifacts/runvalue_model.pkl</code>).</li>
          <li>Initialize batter and pitcher data via name inputs only — no IDs required.</li>
          <li>For a given count and base-state, compute candidate pitches and convert run-value predictions into softmax probabilities, favoring pitches that minimize expected runs:</li>
        </ol>
        <pre class="bg-gray-900 text-gray-100 p-4 rounded mb-4"><code>expected_after_RE = current_RE + predicted_run_value</code></pre>
        <ol class="list-decimal ml-6 space-y-1" start="4">
          <li>Display ranked pitch recommendations with associated probabilities and strike-zone visuals.</li>
          <li>Record pitch outcome → update count and base-state → recompute recommendations.</li>
        </ol>
        <p style="line-height:1.25em;">This stepwise loop allows users to walk through a realistic at-bat.</p>
        <h4 class="font-semibold text-lg mt-4 mb-2">Deployment Notes</h4>
        <ul class="list-disc ml-6 space-y-1">
          <li>On Streamlit Cloud, set the main module to <code>app/app.py</code> (wrapper imports root <code>app.py</code>).</li>
          <li>Large artifacts should be hosted externally or with Git LFS.</li>
          <li>To eliminate <code>InconsistentVersionWarning</code>, re-export models with the target environment’s library versions.</li>
        </ul>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">7. File Map</h3>
        <table class="min-w-full text-sm border border-gray-700 mb-4">
          <thead>
            <tr class="bg-gray-800">
              <th class="px-4 py-2 text-left font-semibold">File</th>
              <th class="px-4 py-2 text-left font-semibold">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>app.py</code></td>
              <td class="px-4 py-2">Main Streamlit UI managing at-bat flow and model integration</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>app/app.py</code></td>
              <td class="px-4 py-2">Hosting wrapper (imports root app)</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>src/preprocess.py</code></td>
              <td class="px-4 py-2">Cleans and normalizes raw Statcast data</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>src/feature_engineering.py</code></td>
              <td class="px-4 py-2">Generates per-play features and batter aggregates</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>src/model_train.py</code></td>
              <td class="px-4 py-2">Model training and artifact creation</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>src/predict.py</code></td>
              <td class="px-4 py-2">Loads model and produces run-value predictions</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>src/attack_recommender.py</code></td>
              <td class="px-4 py-2">Heuristic fallback and matchup helpers</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>src/build_pitcher_arsenals.py</code></td>
              <td class="px-4 py-2">Infers arsenals and writes pitcher_arsenals.csv</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>data/raw/</code></td>
              <td class="px-4 py-2">Raw Statcast CSVs and mapping files</td>
            </tr>
            <tr class="bg-gray-800">
              <td class="px-4 py-2"><code>data/processed/</code></td>
              <td class="px-4 py-2">Parquet outputs for model input</td>
            </tr>
            <tr class="bg-gray-900">
              <td class="px-4 py-2"><code>artifacts/runvalue_model.pkl</code></td>
              <td class="px-4 py-2">Trained pipeline used in production</td>
            </tr>
          </tbody>
        </table>
        <hr class="my-4 border-gray-700">

        <h3 class="font-bold text-xl mt-6 mb-2">8. Future Enhancements</h3>
        <ul class="list-disc ml-6 space-y-2">
          <li>Integrate additional batter-level Statcast metrics (chase rate, contact rate).</li>
          <li>Implement stacked or ensemble models for improved predictive performance.</li>
          <li>Add sequence-level visualization dashboards for post-at-bat analysis.</li>
          <li>Enable authenticated sessions to log and replay saved at-bats.</li>
          <li>Support online retraining to reflect in-season player trends.</li>
        </ul>
      </section>
      <section class="prose max-w-4xl text-gray-200 mt-8 space-y-6">
      </section>
    <footer class="site-footer">
      <div class="container">
        <p class="muted">© 2025 Christopher Hsu</p>
      </div>
    </footer>
  </body>
</html>